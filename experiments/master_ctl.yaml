apiVersion: batch/v1
kind: Job
metadata:
  name: controller
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        app: mantis-controller
    spec:
      serviceAccountName: controller-role
      restartPolicy: Never
      containers:
        - name: controller
          imagePullPolicy: Always
          image: fissure/py:latest
          command: [
            "mantis",
            "run-controller",
            "--load", "/data/Waikato-1h.npy",
            "--workload", "sleep",
            "--workload-args", "sleep_time_s=0.015",
            "--start-replicas", "5",
            "--controller", "pid",
            "--controller-args", "model_processing_time_s=0.015,target_sigma=0.4" 
          ]
          volumeMounts:
          - mountPath: /data
            name: data-volume
          env:
          - name: AWS_ACCESS_KEY_ID
            valueFrom:
              secretKeyRef:
                name: aws-s3-creds
                key: AWS_ACCESS_KEY_ID
          - name: AWS_SECRET_ACCESS_KEY
            valueFrom:
              secretKeyRef:
                name: aws-s3-creds
                key: AWS_SECRET_ACCESS_KEY
          - name: SLACK_ENDPOINT
            valueFrom:
              secretKeyRef:
                name: slack-endpoint
                key: SLACK_ENDPOINT
          resources:
            requests:
              mantis.com/concurrent: 1
            limits:
              mantis.com/concurrent: 1
      initContainers:
        - name: copy-traces
          image: fissure/traces:latest
          command: ["sh", "-c", "cp -r /data/* /trace-data/"]
          volumeMounts:
          - mountPath: /trace-data
            name: data-volume
      volumes:
        - name: data-volume
          hostPath:
            path: /trace-data
            type: DirectoryOrCreate
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: controller-role
subjects:
  - kind: ServiceAccount
    name: controller-role
    namespace: default
roleRef:
  kind: ClusterRole
  name: cluster-admin
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: controller-role
