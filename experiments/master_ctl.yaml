apiVersion: batch/v1
kind: Job
metadata:
  name: controller
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        app: mantis-controller
    spec:
      serviceAccountName: controller-role
      restartPolicy: Never
      containers:
        - name: controller
          imagePullPolicy: Always
          image: fissure/py:latest
          command: [
            "mantis",
            "run-controller",
            "--load", "/data/debug-200-400-qps-2min.npy",
            "--workload", "sleep",
            "--workload-args", "sleep_time_s=0.04",  # qps = 50
            "--controller", "pid",
            "--controller-args", "model_processing_time_s=0.04" # model_processing_time
          ]
          volumeMounts:
          - mountPath: /data
            name: data-volume
      initContainers:
        - name: copy-traces
          image: fissure/traces:latest
          command: ["sh", "-c", "cp -r /data/* /trace-data/"]
          volumeMounts:
          - mountPath: /trace-data
            name: data-volume
      volumes:
        - name: data-volume
          hostPath:
            path: /trace-data
            type: DirectoryOrCreate
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: controller-role
subjects:
  - kind: ServiceAccount
    name: controller-role
    namespace: default
roleRef:
  kind: ClusterRole
  name: cluster-admin
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: controller-role
